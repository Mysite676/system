<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Damar Enterprise Loan System</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
</head>
<body>
    <!-- Login Screen -->
    <div class="login-container" id="loginScreen">
        <div class="login-card">
            <div class="logo">
                <i class="fas fa-hand-holding-usd"></i>
            </div>
            <h2>Damar Enterprise</h2>
            <form class="login-form" id="loginForm">
                <div class="form-group">
                    <label for="username">Username</label>
                    <input type="text" id="username" placeholder="Enter username" required>
                </div>
                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" placeholder="Enter password" required>
                </div>
                <div class="error-message" id="loginError">
                    Invalid username or password
                </div>
                <button type="submit" class="login-btn">
                    <i class="fas fa-sign-in-alt"></i> Login
                </button>
            </form>
        </div>
    </div>

    <!-- Main App (hidden initially) -->
    <div class="app-container" id="appContainer">
        <header>
            <div class="header-content">
                <div class="logo">
                    <i class="fas fa-hand-holding-usd"></i>
                </div>
                <div class="header-text">
                    <h1>Damar Enterprise Loan System</h1>
                    <p class="subtitle">Manage all loan applications and borrowers</p>
                </div>
            </div>
            <button class="dark-mode-toggle" id="darkModeToggle">
                <i class="fas fa-moon"></i>
            </button>
        </header>

        <div class="container">
            <div class="main-content">
                <!-- Tabs -->
                <div class="tabs">
                    <div class="tab active" data-tab="dashboard">Dashboard</div>
                    <div class="tab" data-tab="calculator">Loan Calculator</div>
                    <div class="tab" data-tab="borrowers">Borrowers</div>
                    <div class="tab" data-tab="reports">Reports</div>
                </div>

                <!-- Dashboard Tab -->
                <div class="tab-content active" id="dashboard-tab">
                    <!-- Stats Cards -->
                    <div class="stats-container">
                        <div class="stat-card">
                            <h3>Total Borrowers</h3>
                            <div class="stat-value" id="totalBorrowers">0</div>
                            <p>All customers</p>
                        </div>
                        <div class="stat-card">
                            <h3>Active Loans</h3>
                            <div class="stat-value" id="activeLoans">0</div>
                            <p>Currently active</p>
                        </div>
                        <div class="stat-card">
                            <h3>Overdue Loans</h3>
                            <div class="stat-value" id="overdueLoans">0</div>
                            <p>Past due date</p>
                        </div>
                        <div class="stat-card">
                            <h3>Total Loan Amount</h3>
                            <div class="stat-value" id="totalLoanAmount">ZMW 0</div>
                            <p>All loans combined</p>
                        </div>
                        <div class="stat-card">
                            <h3>Amount Recovered</h3>
                            <div class="stat-value" id="amountRecovered">ZMW 0</div>
                            <p>Total repaid</p>
                        </div>
                        <div class="stat-card">
                            <h3>Profit/Loss</h3>
                            <div class="stat-value" id="profitLoss">ZMW 0</div>
                            <p>This month</p>
                        </div>
                    </div>

                    <!-- Charts -->
                    <div class="chart-container">
                        <div class="chart-header">
                            <h3>Monthly Performance</h3>
                            <select id="chartPeriod" class="btn-outline" style="padding: 5px 8px; font-size: 12px;">
                                <option value="7">Last 7 Days</option>
                                <option value="30" selected>Last 30 Days</option>
                                <option value="90">Last 90 Days</option>
                            </select>
                        </div>
                        <div class="chart-wrapper">
                            <canvas id="performanceChart"></canvas>
                        </div>
                    </div>

                    <div class="chart-container">
                        <div class="chart-header">
                            <h3>Repayment Status</h3>
                        </div>
                        <div class="chart-wrapper">
                            <canvas id="repaymentChart"></canvas>
                        </div>
                    </div>

                    <!-- Due Soon Loans -->
                    <div class="table-container">
                        <div class="section-header">
                            <h2>Loans Due Soon</h2>
                            <button class="btn" id="newLoanBtn">
                                <i class="fas fa-plus"></i> New Loan
                            </button>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Phone</th>
                                    <th>Loan Amount</th>
                                    <th>Due Date</th>
                                    <th>Days Left</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="dueSoonTable">
                                <!-- Due soon loans will be inserted here -->
                            </tbody>
                        </table>
                        <div class="empty-state" id="noDueSoonLoans">
                            <i class="fas fa-check-circle"></i>
                            <h3>No Loans Due Soon</h3>
                            <p>All loans are up to date or have been repaid.</p>
                        </div>
                    </div>
                </div>

                <!-- Loan Calculator Tab -->
                <div class="tab-content" id="calculator-tab">
                    <div class="calculator-container active">
                        <div class="calculator-header">
                            <h2>Loan Calculator</h2>
                        </div>

                        <div class="form-group">
                            <label for="calcLoanAmount">Loan Amount (ZMW)</label>
                            <input type="number" id="calcLoanAmount" min="100" value="1000" required>
                        </div>

                        <div class="form-group">
                            <label>Repayment Period</label>
                            <div class="radio-group">
                                <label class="radio-option">
                                    <input type="radio" name="calcRepaymentPeriod" value="7" checked> 
                                    1 Week (16%)
                                </label>
                                <label class="radio-option">
                                    <input type="radio" name="calcRepaymentPeriod" value="14"> 
                                    2 Weeks (20%)
                                </label>
                                <label class="radio-option">
                                    <input type="radio" name="calcRepaymentPeriod" value="21"> 
                                    3 Weeks (25%)
                                </label>
                                <label class="radio-option">
                                    <input type="radio" name="calcRepaymentPeriod" value="28"> 
                                    4 Weeks (30%)
                                </label>
                            </div>
                        </div>

                        <button type="button" class="btn" id="calculateBtn" style="width: 100%;">
                            <i class="fas fa-calculator"></i> Calculate
                        </button>

                        <div class="calculator-results" id="calculatorResults" style="display: none;">
                            <h4>Loan Calculation Results</h4>
                            <p>Principal Amount: <span class="result-value" id="calcPrincipal">ZMW 0</span></p>
                            <p>Interest Amount: <span class="result-value" id="calcInterest">ZMW 0</span></p>
                            <p>Total Repayment: <span class="result-value" id="calcTotal">ZMW 0</span></p>
                            <p>Daily Repayment: <span class="result-value" id="calcDaily">ZMW 0</span></p>
                            <p>Weekly Repayment: <span class="result-value" id="calcWeekly">ZMW 0</span></p>
                        </div>
                    </div>
                </div>

                <!-- Borrowers Tab -->
                <div class="tab-content" id="borrowers-tab">
                    <!-- New Loan Form -->
                    <div class="form-container" id="loanForm">
                        <div class="form-header">
                            <h2>New Loan Application</h2>
                            <p>Fill in the details to add a new loan</p>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="firstName">First Name</label>
                                <input type="text" id="firstName" required>
                            </div>
                            <div class="form-group">
                                <label for="lastName">Last Name</label>
                                <input type="text" id="lastName" required>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="nrc">NRC Number</label>
                                <input type="text" id="nrc" placeholder="e.g. 123456/78/9" required>
                            </div>
                            <div class="form-group">
                                <label for="age">Age</label>
                                <input type="number" id="age" min="18" max="99" required>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="gender">Gender</label>
                            <select id="gender" required>
                                <option value="">Select Gender</option>
                                <option value="Male">Male</option>
                                <option value="Female">Female</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="phone">Phone Number</label>
                            <input type="tel" id="phone" placeholder="e.g. 0971234567" required>
                        </div>

                        <div class="form-group">
                            <label for="address">Address</label>
                            <input type="text" id="address" placeholder="House #, Area" required>
                        </div>

                        <div class="form-group">
                            <label for="loanPurpose">Loan Purpose</label>
                            <select id="loanPurpose" required>
                                <option value="">Select Purpose</option>
                                <option value="Business">Business</option>
                                <option value="Medical">Medical</option>
                                <option value="Education">Education</option>
                                <option value="Personal">Personal</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="loanAmount">Loan Amount (ZMW)</label>
                            <input type="number" id="loanAmount" min="100" value="100" required>
                        </div>

                        <div class="form-group">
                            <label>Repayment Period</label>
                            <div class="radio-group">
                                <label class="radio-option">
                                    <input type="radio" name="repaymentPeriod" value="7" checked> 
                                    1 Week
                                </label>
                                <label class="radio-option">
                                    <input type="radio" name="repaymentPeriod" value="14"> 
                                    2 Weeks
                                </label>
                                <label class="radio-option">
                                    <input type="radio" name="repaymentPeriod" value="21"> 
                                    3 Weeks
                                </label>
                                <label class="radio-option">
                                    <input type="radio" name="repaymentPeriod" value="28"> 
                                    4 Weeks
                                </label>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="checkbox-option">
                                <input type="checkbox" id="termsAgreement" required>
                                I understand that late repayment may result in legal action under Zambian law. By signing, I accept all terms.
                            </label>
                        </div>

                        <div class="form-actions">
                            <button type="button" class="btn btn-outline" id="cancelLoanBtn">
                                Cancel
                            </button>
                            <button type="button" class="btn" id="submitLoanBtn">
                                <i class="fas fa-save"></i> Save Loan
                            </button>
                        </div>
                    </div>

                    <!-- Borrowers Table -->
                    <div class="table-container">
                        <div class="section-header">
                            <h2>Active Loans</h2>
                            <div>
                                <button class="btn" id="newLoanBtn2">
                                    <i class="fas fa-plus"></i> New Loan
                                </button>
                                <button class="btn btn-outline" id="exportPdfBtn">
                                    <i class="fas fa-file-pdf"></i> Export
                                </button>
                            </div>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Phone</th>
                                    <th>Loan Amount</th>
                                    <th>Status</th>
                                    <th>Due Date</th>
                                    <th>Days Left</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="borrowersTable">
                                <!-- Borrowers will be inserted here -->
                            </tbody>
                        </table>
                        <div class="empty-state" id="noBorrowers">
                            <i class="fas fa-user-friends"></i>
                            <h3>No Active Loans</h3>
                            <p>There are currently no active loans in the system. Click "New Loan" to add one.</p>
                        </div>
                    </div>

                    <!-- Paid Loans Table -->
                    <div class="table-container">
                        <div class="section-header">
                            <h2>Paid Loans</h2>
                            <button class="btn btn-outline" id="exportPaidPdfBtn">
                                <i class="fas fa-file-pdf"></i> Export
                            </button>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Phone</th>
                                    <th>Loan Amount</th>
                                    <th>Repaid Amount</th>
                                    <th>Paid Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="paidLoansTable">
                                <!-- Paid loans will be inserted here -->
                            </tbody>
                        </table>
                        <div class="empty-state" id="noPaidLoans">
                            <i class="fas fa-check-circle"></i>
                            <h3>No Paid Loans</h3>
                            <p>There are currently no paid loans in the system.</p>
                        </div>
                    </div>
                </div>

                <!-- Reports Tab -->
                <div class="tab-content" id="reports-tab">
                    <div class="chart-container">
                        <div class="chart-header">
                            <h3>Monthly Profit/Loss</h3>
                            <select id="profitChartPeriod" class="btn-outline" style="padding: 5px 8px; font-size: 12px;">
                                <option value="3">Last 3 Months</option>
                                <option value="6" selected>Last 6 Months</option>
                                <option value="12">Last 12 Months</option>
                            </select>
                        </div>
                        <div class="chart-wrapper">
                            <canvas id="profitChart"></canvas>
                        </div>
                    </div>

                    <div class="table-container">
                        <div class="section-header">
                            <h2>Loan Performance</h2>
                            <button class="btn" id="generateReportBtn">
                                <i class="fas fa-file-excel"></i> Generate Report
                            </button>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th>Month</th>
                                    <th>Loans Given</th>
                                    <th>Amount Lent</th>
                                    <th>Amount Recovered</th>
                                    <th>Profit/Loss</th>
                                    <th>Default Rate</th>
                                </tr>
                            </thead>
                            <tbody id="performanceTable">
                                <!-- Performance data will be inserted here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Mark as Paid Modal -->
        <div class="modal" id="paidModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Mark Loan as Paid</h3>
                    <button class="close-modal" id="closePaidModal">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="paidAmount">Amount Paid (ZMW)</label>
                        <input type="number" id="paidAmount" min="0" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label for="paymentDate">Payment Date</label>
                        <input type="date" id="paymentDate" required>
                    </div>
                    <div class="form-group">
                        <label for="paymentNotes">Notes (Optional)</label>
                        <textarea id="paymentNotes" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-outline" id="cancelPaymentBtn">Cancel</button>
                    <button class="btn" id="confirmPaymentBtn">Confirm Payment</button>
                </div>
            </div>
        </div>

        <!-- Notification -->
        <div class="notification" id="notification">
            <div class="notification-icon">
                <i class="fas fa-bell"></i>
            </div>
            <div class="notification-content">
                <h4 id="notificationTitle">Loan Due Soon</h4>
                <p id="notificationMessage">A loan is due in 3 days</p>
            </div>
            <button class="close-notification" id="closeNotification">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyALIYbilBnKvf5EwFJ9_JdwofUWmLwydW0",
            authDomain: "damar-loan-system.firebaseapp.com",
            databaseURL: "https://damar-loan-system-default-rtdb.firebaseio.com",
            projectId: "damar-loan-system",
            storageBucket: "damar-loan-system.firebasestorage.app",
            messagingSenderId: "192493023896",
            appId: "1:192493023896:web:ca8259d856c73ff0ee96ed",
            measurementId: "G-EJ74D1G9WK"
        };

        // Initialize Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const database = firebase.database();

        // Global variables
        let isDarkMode = false;
        let borrowersData = [];
        let paidLoansData = [];
        let notificationTimeout;
        let performanceChart, repaymentChart, profitChart;
        let currentLoanId = null;
        const { jsPDF } = window.jspdf;

        // Dark mode toggle
        function toggleDarkMode() {
            isDarkMode = !isDarkMode;
            document.body.classList.toggle('dark-mode', isDarkMode);
            localStorage.setItem('darkMode', isDarkMode);
            updateDarkModeButton();
            updateChartsTheme();
        }

        function updateDarkModeButton() {
            const icon = document.getElementById('darkModeToggle').querySelector('i');
            if (isDarkMode) {
                icon.classList.remove('fa-moon');
                icon.classList.add('fa-sun');
            } else {
                icon.classList.remove('fa-sun');
                icon.classList.add('fa-moon');
            }
        }

        // Update charts theme based on dark mode
        function updateChartsTheme() {
            const textColor = isDarkMode ? '#f8f9fa' : '#343a40';
            const gridColor = isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
            
            if (performanceChart) {
                performanceChart.options.scales.x.grid.color = gridColor;
                performanceChart.options.scales.y.grid.color = gridColor;
                performanceChart.options.scales.x.ticks.color = textColor;
                performanceChart.options.scales.y.ticks.color = textColor;
                performanceChart.update();
            }
            
            if (repaymentChart) {
                repaymentChart.options.plugins.legend.labels.color = textColor;
                repaymentChart.update();
            }
            
            if (profitChart) {
                profitChart.options.scales.x.grid.color = gridColor;
                profitChart.options.scales.y.grid.color = gridColor;
                profitChart.options.scales.x.ticks.color = textColor;
                profitChart.options.scales.y.ticks.color = textColor;
                profitChart.update();
            }
        }

        // Check for saved dark mode preference
        if (localStorage.getItem('darkMode') === 'true') {
            isDarkMode = true;
            document.body.classList.add('dark-mode');
        }
        updateDarkModeButton();

        // Format currency
        function formatCurrency(amount) {
            return `ZMW ${parseFloat(amount).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",")}`;
        }

        // Get days until due
        function getDaysUntilDue(dueDateStr) {
            if (!dueDateStr) return null;
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const dueDate = new Date(dueDateStr.split('/').reverse().join('-'));
            dueDate.setHours(0, 0, 0, 0);
            const diffTime = dueDate - today;
            return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        }

        // Get status badge
        function getStatusBadge(status, daysUntilDue, repaid) {
            if (repaid) {
                return '<span class="status-badge status-repaid">Repaid</span>';
            }
            
            if (status === 'Pending') {
                return '<span class="status-badge status-pending">Pending</span>';
            }
            
            if (status === 'Rejected') {
                return '<span class="status-badge status-rejected">Rejected</span>';
            }
            
            if (daysUntilDue === null) {
                return '<span class="status-badge status-active">Active</span>';
            }
            
            if (daysUntilDue < 0) {
                return '<span class="status-badge status-overdue">Overdue</span>';
            }
            
            if (daysUntilDue === 0) {
                return '<span class="status-badge status-overdue">Due Today</span>';
            }
            
            if (daysUntilDue <= 3) {
                return '<span class="status-badge status-overdue">Due Soon</span>';
            }
            
            return '<span class="status-badge status-active">Active</span>';
        }

        // Format days left
        function formatDaysLeft(days) {
            if (days === null) return '-';
            if (days < 0) return `${Math.abs(days)} days ago`;
            if (days === 0) return 'Today';
            return `${days} days`;
        }

        // Calculate due date
        function calculateDueDate(daysToAdd) {
            const today = new Date();
            const dueDate = new Date(today);
            dueDate.setDate(today.getDate() + parseInt(daysToAdd));
            return dueDate.toLocaleDateString('en-GB');
        }

        // Show notification
        function showNotification(title, message, type = 'due-soon') {
            const notification = document.getElementById('notification');
            notification.className = `notification ${type} show`;
            document.getElementById('notificationTitle').textContent = title;
            document.getElementById('notificationMessage').textContent = message;
            
            // Play sound for important notifications
            if (type === 'due-today' || type === 'paid') {
                const audio = new Audio('https://assets.mixkit.co/sfx/preview/mixkit-alarm-digital-clock-beep-989.mp3');
                audio.play().catch(e => console.log('Audio playback failed:', e));
            }
            
            // Hide after 5 seconds
            clearTimeout(notificationTimeout);
            notificationTimeout = setTimeout(() => {
                notification.classList.remove('show');
            }, 5000);
        }

        // Close notification
        function closeNotification() {
            document.getElementById('notification').classList.remove('show');
        }

        // Add loan to database
        function addLoan(loanData) {
            const loansRef = database.ref('applications');
            const newLoanRef = loansRef.push();
            
            // Show loading state
            const submitBtn = document.getElementById('submitLoanBtn');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<span class="spinner"></span> Processing...';
            submitBtn.disabled = true;
            
            return newLoanRef.set(loanData)
                .then(() => {
                    showNotification('Loan Added', 'New loan has been added successfully', 'paid');
                    toggleForm();
                    resetForm();
                })
                .catch(error => {
                    console.error("Error adding loan:", error);
                    showNotification('Error', 'Failed to add loan. Please try again.', 'due-today');
                })
                .finally(() => {
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                });
        }

        // Mark loan as paid
        function markLoanAsPaid(loanId, paymentData) {
            const loanRef = database.ref(`applications/${loanId}`);
            
            // Show loading state
            const confirmBtn = document.getElementById('confirmPaymentBtn');
            const originalText = confirmBtn.innerHTML;
            confirmBtn.innerHTML = '<span class="spinner"></span> Processing...';
            confirmBtn.disabled = true;
            
            return loanRef.update({
                repaid: true,
                paidAmount: paymentData.amount,
                paymentDate: paymentData.date,
                paymentNotes: paymentData.notes,
                status: 'Repaid'
            })
            .then(() => {
                showNotification('Payment Recorded', 'Loan has been marked as paid', 'paid');
                closeModal('paidModal');
            })
            .catch(error => {
                console.error("Error marking loan as paid:", error);
                showNotification('Error', 'Failed to record payment. Please try again.', 'due-today');
            })
            .finally(() => {
                confirmBtn.innerHTML = originalText;
                confirmBtn.disabled = false;
            });
        }

        // Accept loan application
        function acceptLoan(loanId) {
            if (confirm('Are you sure you want to accept this loan application?')) {
                const loanRef = database.ref(`applications/${loanId}`);
                
                // Show loading state
                const acceptBtn = document.querySelector(`button[onclick="acceptLoan('${loanId}')"]`);
                if (acceptBtn) {
                    acceptBtn.innerHTML = '<span class="spinner"></span> Processing...';
                    acceptBtn.disabled = true;
                }
                
                loanRef.update({
                    status: 'Active',
                    dueDate: calculateDueDate(28) // Default to 4 weeks if not specified
                })
                .then(() => {
                    showNotification('Loan Accepted', 'The loan has been approved and marked as active', 'paid');
                })
                .catch(error => {
                    console.error("Error accepting loan:", error);
                    showNotification('Error', 'Failed to accept loan. Please try again.', 'due-today');
                })
                .finally(() => {
                    if (acceptBtn) {
                        acceptBtn.innerHTML = '<i class="fas fa-check"></i> Accept';
                        acceptBtn.disabled = false;
                    }
                });
            }
        }

        // Decline loan application
        function declineLoan(loanId) {
            if (confirm('Are you sure you want to decline this loan application?')) {
                const loanRef = database.ref(`applications/${loanId}`);
                
                // Show loading state
                const declineBtn = document.querySelector(`button[onclick="declineLoan('${loanId}')"]`);
                if (declineBtn) {
                    declineBtn.innerHTML = '<span class="spinner"></span> Processing...';
                    declineBtn.disabled = true;
                }
                
                loanRef.update({
                    status: 'Rejected'
                })
                .then(() => {
                    showNotification('Loan Declined', 'The loan application has been rejected', 'due-today');
                })
                .catch(error => {
                    console.error("Error declining loan:", error);
                    showNotification('Error', 'Failed to decline loan. Please try again.', 'due-today');
                })
                .finally(() => {
                    if (declineBtn) {
                        declineBtn.innerHTML = '<i class="fas fa-times"></i> Decline';
                        declineBtn.disabled = false;
                    }
                });
            }
        }

        // Reset form
        function resetForm() {
            document.getElementById('firstName').value = '';
            document.getElementById('lastName').value = '';
            document.getElementById('nrc').value = '';
            document.getElementById('age').value = '';
            document.getElementById('gender').value = '';
            document.getElementById('phone').value = '';
            document.getElementById('address').value = '';
            document.getElementById('loanPurpose').value = '';
            document.getElementById('loanAmount').value = '100';
            document.querySelector('input[name="repaymentPeriod"]:checked').checked = true;
            document.getElementById('termsAgreement').checked = false;
        }

        // Fetch all borrowers from database
        function fetchBorrowers() {
            const loansRef = database.ref('applications');
            loansRef.on('value', (snapshot) => {
                const borrowers = [];
                const paidLoans = [];
                let totalBorrowers = 0;
                let activeLoans = 0;
                let overdueLoans = 0;
                let totalLoanAmount = 0;
                let amountRecovered = 0;
                
                if (snapshot.exists()) {
                    snapshot.forEach(childSnapshot => {
                        const borrower = {
                            id: childSnapshot.key,
                            ...childSnapshot.val()
                        };
                        
                        // Calculate days until due
                        borrower.daysUntilDue = getDaysUntilDue(borrower.dueDate);
                        
                        // Count stats
                        totalBorrowers++;
                        
                        if (borrower.repaid) {
                            paidLoans.push(borrower);
                            amountRecovered += parseFloat(borrower.paidAmount) || 0;
                        } else {
                            totalLoanAmount += parseFloat(borrower.loanAmount) || 0;
                            
                            if (borrower.status === 'Active') {
                                activeLoans++;
                                
                                if (borrower.daysUntilDue !== null && borrower.daysUntilDue < 0) {
                                    overdueLoans++;
                                }
                            }
                            
                            borrowers.push(borrower);
                        }
                    });
                }
                
                borrowersData = borrowers;
                paidLoansData = paidLoans;
                renderBorrowers(borrowers);
                renderPaidLoans(paidLoans);
                renderDueSoonLoans(borrowers);
                
                // Update stats
                document.getElementById('totalBorrowers').textContent = totalBorrowers;
                document.getElementById('activeLoans').textContent = activeLoans;
                document.getElementById('overdueLoans').textContent = overdueLoans;
                document.getElementById('totalLoanAmount').textContent = formatCurrency(totalLoanAmount);
                document.getElementById('amountRecovered').textContent = formatCurrency(amountRecovered);
                document.getElementById('profitLoss').textContent = formatCurrency(amountRecovered - totalLoanAmount);
                
                // Check for due dates and show notifications
                checkDueDates(borrowers);
                
                // Update charts
                updatePerformanceChart(borrowers, paidLoans);
                updateRepaymentChart(borrowers, paidLoans);
                updateProfitChart(paidLoans);
                updatePerformanceTable(paidLoans);
            });
        }

        // Check for loans due soon and show notifications
        function checkDueDates(borrowers) {
            const today = new Date();
            
            borrowers.forEach(borrower => {
                if (!borrower.repaid && borrower.status === 'Active') {
                    if (borrower.daysUntilDue === 3) {
                        showNotification(
                            'Loan Due Soon', 
                            `${borrower.firstName}'s loan is due in 3 days (${borrower.dueDate})`, 
                            'due-soon'
                        );
                    } else if (borrower.daysUntilDue === 1) {
                        showNotification(
                            'Loan Due Tomorrow', 
                            `${borrower.firstName}'s loan is due tomorrow`, 
                            'due-soon'
                        );
                    } else if (borrower.daysUntilDue === 0) {
                        showNotification(
                            'Loan Due Today', 
                            `${borrower.firstName}'s loan is due today`, 
                            'due-today'
                        );
                    } else if (borrower.daysUntilDue < 0) {
                        showNotification(
                            'Loan Overdue', 
                            `${borrower.firstName}'s loan is ${Math.abs(borrower.daysUntilDue)} days overdue`, 
                            'due-today'
                        );
                    }
                }
            });
        }

        // Render borrowers to the table
        function renderBorrowers(borrowers) {
            const borrowersTable = document.getElementById('borrowersTable');
            borrowersTable.innerHTML = '';
            
            if (borrowers.length === 0) {
                document.getElementById('noBorrowers').style.display = 'block';
                return;
            }
            
            document.getElementById('noBorrowers').style.display = 'none';
            
            // Sort borrowers by due date (soonest first)
            borrowers.sort((a, b) => {
                if (a.daysUntilDue === null && b.daysUntilDue === null) return 0;
                if (a.daysUntilDue === null) return 1;
                if (b.daysUntilDue === null) return -1;
                return a.daysUntilDue - b.daysUntilDue;
            });
            
            borrowers.forEach(borrower => {
                if (borrower.repaid) return;
                
                const row = document.createElement('tr');
                
                // Name
                const nameCell = document.createElement('td');
                nameCell.textContent = `${borrower.firstName} ${borrower.lastName}`;
                row.appendChild(nameCell);
                
                // Phone
                const phoneCell = document.createElement('td');
                phoneCell.textContent = borrower.phone || '-';
                row.appendChild(phoneCell);
                
                // Loan Amount
                const amountCell = document.createElement('td');
                amountCell.textContent = formatCurrency(borrower.loanAmount || 0);
                row.appendChild(amountCell);
                
                // Status
                const statusCell = document.createElement('td');
                statusCell.innerHTML = getStatusBadge(
                    borrower.status, 
                    borrower.daysUntilDue, 
                    borrower.repaid
                );
                row.appendChild(statusCell);
                
                // Due Date
                const dueDateCell = document.createElement('td');
                dueDateCell.textContent = borrower.dueDate || '-';
                row.appendChild(dueDateCell);
                
                // Days Left
                const daysLeftCell = document.createElement('td');
                daysLeftCell.textContent = formatDaysLeft(borrower.daysUntilDue);
                row.appendChild(daysLeftCell);
                
                // Actions
                const actionsCell = document.createElement('td');
                actionsCell.className = 'action-buttons';
                
                if (borrower.status === 'Pending') {
                    const acceptBtn = document.createElement('button');
                    acceptBtn.className = 'action-btn accept';
                    acceptBtn.innerHTML = '<i class="fas fa-check"></i> Accept';
                    acceptBtn.onclick = () => acceptLoan(borrower.id);
                    actionsCell.appendChild(acceptBtn);
                    
                    const declineBtn = document.createElement('button');
                    declineBtn.className = 'action-btn decline';
                    declineBtn.innerHTML = '<i class="fas fa-times"></i> Decline';
                    declineBtn.onclick = () => declineLoan(borrower.id);
                    actionsCell.appendChild(declineBtn);
                }
                else if (borrower.status === 'Active') {
                    const paidBtn = document.createElement('button');
                    paidBtn.className = 'action-btn paid';
                    paidBtn.innerHTML = '<i class="fas fa-check-circle"></i> Paid';
                    paidBtn.onclick = () => openModal('paidModal', borrower.id);
                    actionsCell.appendChild(paidBtn);
                    
                    if (borrower.daysUntilDue < 0) {
                        const lateFeeBtn = document.createElement('button');
                        lateFeeBtn.className = 'action-btn overdue';
                        lateFeeBtn.innerHTML = '<i class="fas fa-exclamation-circle"></i> Late Fee';
                        lateFeeBtn.onclick = () => addLateFee(borrower.id);
                        actionsCell.appendChild(lateFeeBtn);
                    }
                }
                
                row.appendChild(actionsCell);
                
                borrowersTable.appendChild(row);
            });
        }

        // Render paid loans to the table
        function renderPaidLoans(paidLoans) {
            const paidLoansTable = document.getElementById('paidLoansTable');
            paidLoansTable.innerHTML = '';
            
            if (paidLoans.length === 0) {
                document.getElementById('noPaidLoans').style.display = 'block';
                return;
            }
            
            document.getElementById('noPaidLoans').style.display = 'none';
            
            // Sort paid loans by payment date (newest first)
            paidLoans.sort((a, b) => {
                const dateA = a.paymentDate ? new Date(a.paymentDate.split('/').reverse().join('-')) : new Date(0);
                const dateB = b.paymentDate ? new Date(b.paymentDate.split('/').reverse().join('-')) : new Date(0);
                return dateB - dateA;
            });
            
            paidLoans.forEach(loan => {
                const row = document.createElement('tr');
                
                // Name
                const nameCell = document.createElement('td');
                nameCell.textContent = `${loan.firstName} ${loan.lastName}`;
                row.appendChild(nameCell);
                
                // Phone
                const phoneCell = document.createElement('td');
                phoneCell.textContent = loan.phone || '-';
                row.appendChild(phoneCell);
                
                // Loan Amount
                const amountCell = document.createElement('td');
                amountCell.textContent = formatCurrency(loan.loanAmount || 0);
                row.appendChild(amountCell);
                
                // Repaid Amount
                const repaidCell = document.createElement('td');
                repaidCell.textContent = formatCurrency(loan.paidAmount || 0);
                row.appendChild(repaidCell);
                
                // Paid Date
                const paidDateCell = document.createElement('td');
                paidDateCell.textContent = loan.paymentDate || '-';
                row.appendChild(paidDateCell);
                
                // Actions
                const actionsCell = document.createElement('td');
                const receiptBtn = document.createElement('button');
                receiptBtn.className = 'action-btn';
                receiptBtn.innerHTML = '<i class="fas fa-receipt"></i> Receipt';
                receiptBtn.onclick = () => generateReceipt(loan);
                actionsCell.appendChild(receiptBtn);
                row.appendChild(actionsCell);
                
                paidLoansTable.appendChild(row);
            });
        }

        // Render due soon loans to the table
        function renderDueSoonLoans(borrowers) {
            const dueSoonTable = document.getElementById('dueSoonTable');
            dueSoonTable.innerHTML = '';
            
            // Filter loans due in the next 7 days or overdue
            const dueSoonLoans = borrowers.filter(borrower => {
                return !borrower.repaid && 
                       borrower.status === 'Active' && 
                       borrower.daysUntilDue !== null && 
                       borrower.daysUntilDue <= 7;
            });
            
            if (dueSoonLoans.length === 0) {
                document.getElementById('noDueSoonLoans').style.display = 'block';
                return;
            }
            
            document.getElementById('noDueSoonLoans').style.display = 'none';
            
            // Sort by days until due (soonest first)
            dueSoonLoans.sort((a, b) => a.daysUntilDue - b.daysUntilDue);
            
            dueSoonLoans.forEach(borrower => {
                const row = document.createElement('tr');
                
                // Name
                const nameCell = document.createElement('td');
                nameCell.textContent = `${borrower.firstName} ${borrower.lastName}`;
                row.appendChild(nameCell);
                
                // Phone
                const phoneCell = document.createElement('td');
                phoneCell.textContent = borrower.phone || '-';
                row.appendChild(phoneCell);
                
                // Loan Amount
                const amountCell = document.createElement('td');
                amountCell.textContent = formatCurrency(borrower.loanAmount || 0);
                row.appendChild(amountCell);
                
                // Due Date
                const dueDateCell = document.createElement('td');
                dueDateCell.textContent = borrower.dueDate || '-';
                row.appendChild(dueDateCell);
                
                // Days Left
                const daysLeftCell = document.createElement('td');
                daysLeftCell.textContent = formatDaysLeft(borrower.daysUntilDue);
                row.appendChild(daysLeftCell);
                
                // Actions
                const actionsCell = document.createElement('td');
                const paidBtn = document.createElement('button');
                paidBtn.className = 'action-btn paid';
                paidBtn.innerHTML = '<i class="fas fa-check-circle"></i> Paid';
                paidBtn.onclick = () => openModal('paidModal', borrower.id);
                actionsCell.appendChild(paidBtn);
                
                if (borrower.daysUntilDue < 0) {
                    const lateFeeBtn = document.createElement('button');
                    lateFeeBtn.className = 'action-btn overdue';
                    lateFeeBtn.innerHTML = '<i class="fas fa-exclamation-circle"></i> Late Fee';
                    lateFeeBtn.onclick = () => addLateFee(borrower.id);
                    actionsCell.appendChild(lateFeeBtn);
                }
                
                row.appendChild(actionsCell);
                
                dueSoonTable.appendChild(row);
            });
        }

        // Update performance chart
        function updatePerformanceChart(borrowers, paidLoans) {
            const ctx = document.getElementById('performanceChart').getContext('2d');
            const period = parseInt(document.getElementById('chartPeriod').value);
            const endDate = new Date();
            const startDate = new Date();
            startDate.setDate(endDate.getDate() - period);
            
            // Group data by day
            const daysData = {};
            for (let i = 0; i <= period; i++) {
                const date = new Date(startDate);
                date.setDate(startDate.getDate() + i);
                const dateStr = date.toISOString().split('T')[0];
                daysData[dateStr] = { loans: 0, repaid: 0 };
            }
            
            // Count loans given per day
            borrowers.forEach(borrower => {
                if (borrower.applicationDate) {
                    const loanDate = new Date(borrower.applicationDate);
                    const loanDateStr = loanDate.toISOString().split('T')[0];
                    if (daysData[loanDateStr]) {
                        daysData[loanDateStr].loans += parseFloat(borrower.loanAmount) || 0;
                    }
                }
            });
            
            // Count repayments per day
            paidLoans.forEach(loan => {
                if (loan.paymentDate) {
                    const paymentDate = new Date(loan.paymentDate.split('/').reverse().join('-'));
                    const paymentDateStr = paymentDate.toISOString().split('T')[0];
                    if (daysData[paymentDateStr]) {
                        daysData[paymentDateStr].repaid += parseFloat(loan.paidAmount) || 0;
                    }
                }
            });
            
            // Prepare chart data
            const labels = Object.keys(daysData).map(date => {
                const d = new Date(date);
                return d.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' });
            });
            
            const loansData = Object.values(daysData).map(day => day.loans);
            const repaidData = Object.values(daysData).map(day => day.repaid);
            
            // Destroy previous chart if exists
            if (performanceChart) {
                performanceChart.destroy();
            }
            
            // Create new chart
            performanceChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Loans Given',
                            data: loansData,
                            backgroundColor: 'rgba(46, 139, 87, 0.7)',
                            borderColor: 'rgba(46, 139, 87, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Amount Recovered',
                            data: repaidData,
                            backgroundColor: 'rgba(30, 144, 255, 0.7)',
                            borderColor: 'rgba(30, 144, 255, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            grid: {
                                color: isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'
                            },
                            ticks: {
                                color: isDarkMode ? '#f8f9fa' : '#343a40'
                            }
                        },
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'
                            },
                            ticks: {
                                color: isDarkMode ? '#f8f9fa' : '#343a40',
                                callback: function(value) {
                                    return 'ZMW ' + value.toLocaleString();
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: isDarkMode ? '#f8f9fa' : '#343a40'
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    label += 'ZMW ' + context.raw.toLocaleString();
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Update repayment status chart
        function updateRepaymentChart(borrowers, paidLoans) {
            const ctx = document.getElementById('repaymentChart').getContext('2d');
            
            // Calculate status counts
            const statusCounts = {
                paid: paidLoans.length,
                active: borrowers.filter(b => b.status === 'Active' && !b.repaid).length,
                overdue: borrowers.filter(b => b.status === 'Active' && !b.repaid && b.daysUntilDue < 0).length,
                pending: borrowers.filter(b => b.status === 'Pending').length,
                rejected: borrowers.filter(b => b.status === 'Rejected').length
            };
            
            // Destroy previous chart if exists
            if (repaymentChart) {
                repaymentChart.destroy();
            }
            
            // Create new chart
            repaymentChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Paid', 'Active', 'Overdue', 'Pending', 'Rejected'],
                    datasets: [{
                        data: [statusCounts.paid, statusCounts.active, statusCounts.overdue, statusCounts.pending, statusCounts.rejected],
                        backgroundColor: [
                            'rgba(46, 204, 113, 0.7)',
                            'rgba(52, 152, 219, 0.7)',
                            'rgba(231, 76, 60, 0.7)',
                            'rgba(243, 156, 18, 0.7)',
                            'rgba(149, 165, 166, 0.7)'
                        ],
                        borderColor: [
                            'rgba(46, 204, 113, 1)',
                            'rgba(52, 152, 219, 1)',
                            'rgba(231, 76, 60, 1)',
                            'rgba(243, 156, 18, 1)',
                            'rgba(149, 165, 166, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: isDarkMode ? '#f8f9fa' : '#343a40'
                            }
                        }
                    }
                }
            });
        }

        // Update profit chart
        function updateProfitChart(paidLoans) {
            const ctx = document.getElementById('profitChart').getContext('2d');
            const period = parseInt(document.getElementById('profitChartPeriod').value);
            const endDate = new Date();
            const startDate = new Date();
            startDate.setMonth(endDate.getMonth() - period);
            
            // Group data by month
            const monthsData = {};
            for (let i = 0; i <= period; i++) {
                const date = new Date(startDate);
                date.setMonth(startDate.getMonth() + i);
                const monthYear = date.toLocaleDateString('en-GB', { month: 'short', year: 'numeric' });
                monthsData[monthYear] = { loans: 0, repaid: 0, profit: 0 };
            }
            
            // Calculate profit per month
            paidLoans.forEach(loan => {
                if (loan.paymentDate) {
                    const paymentDate = new Date(loan.paymentDate.split('/').reverse().join('-'));
                    const monthYear = paymentDate.toLocaleDateString('en-GB', { month: 'short', year: 'numeric' });
                    if (monthsData[monthYear]) {
                        monthsData[monthYear].loans += parseFloat(loan.loanAmount) || 0;
                        monthsData[monthYear].repaid += parseFloat(loan.paidAmount) || 0;
                        monthsData[monthYear].profit = monthsData[monthYear].repaid - monthsData[monthYear].loans;
                    }
                }
            });
            
            // Prepare chart data
            const labels = Object.keys(monthsData);
            const profitData = Object.values(monthsData).map(month => month.profit);
            
            // Destroy previous chart if exists
            if (profitChart) {
                profitChart.destroy();
            }
            
            // Create new chart
            profitChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Profit/Loss',
                        data: profitData,
                        backgroundColor: profitData.map(value => 
                            value >= 0 ? 'rgba(46, 204, 113, 0.2)' : 'rgba(231, 76, 60, 0.2)'
                        ),
                        borderColor: profitData.map(value => 
                            value >= 0 ? 'rgba(46, 204, 113, 1)' : 'rgba(231, 76, 60, 1)'
                        ),
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            grid: {
                                color: isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'
                            },
                            ticks: {
                                color: isDarkMode ? '#f8f9fa' : '#343a40'
                            }
                        },
                        y: {
                            grid: {
                                color: isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'
                            },
                            ticks: {
                                color: isDarkMode ? '#f8f9fa' : '#343a40',
                                callback: function(value) {
                                    return 'ZMW ' + value.toLocaleString();
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: isDarkMode ? '#f8f9fa' : '#343a40'
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    label += 'ZMW ' + context.raw.toLocaleString();
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Update performance table
        function updatePerformanceTable(paidLoans) {
            const performanceTable = document.getElementById('performanceTable');
            performanceTable.innerHTML = '';
            
            // Group data by month
            const monthsData = {};
            paidLoans.forEach(loan => {
                if (loan.paymentDate) {
                    const paymentDate = new Date(loan.paymentDate.split('/').reverse().join('-'));
                    const monthYear = paymentDate.toLocaleDateString('en-GB', { month: 'long', year: 'numeric' });
                    
                    if (!monthsData[monthYear]) {
                        monthsData[monthYear] = {
                            loans: 0,
                            repaid: 0,
                            count: 0
                        };
                    }
                    
                    monthsData[monthYear].loans += parseFloat(loan.loanAmount) || 0;
                    monthsData[monthYear].repaid += parseFloat(loan.paidAmount) || 0;
                    monthsData[monthYear].count++;
                }
            });
            
            // Add rows to table
            Object.entries(monthsData).forEach(([month, data]) => {
                const profit = data.repaid - data.loans;
                const defaultRate = 0; // Would need more data to calculate this
                
                const row = document.createElement('tr');
                
                // Month
                const monthCell = document.createElement('td');
                monthCell.textContent = month;
                row.appendChild(monthCell);
                
                // Loans Given
                const loansCell = document.createElement('td');
                loansCell.textContent = data.count;
                row.appendChild(loansCell);
                
                // Amount Lent
                const lentCell = document.createElement('td');
                lentCell.textContent = formatCurrency(data.loans);
                row.appendChild(lentCell);
                
                // Amount Recovered
                const recoveredCell = document.createElement('td');
                recoveredCell.textContent = formatCurrency(data.repaid);
                row.appendChild(recoveredCell);
                
                // Profit/Loss
                const profitCell = document.createElement('td');
                profitCell.textContent = formatCurrency(profit);
                profitCell.style.color = profit >= 0 ? 'var(--success-color)' : 'var(--danger-color)';
                row.appendChild(profitCell);
                
                // Default Rate
                const defaultCell = document.createElement('td');
                defaultCell.textContent = defaultRate.toFixed(1) + '%';
                row.appendChild(defaultCell);
                
                performanceTable.appendChild(row);
            });
        }

        // Toggle form visibility
        function toggleForm() {
            document.getElementById('loanForm').classList.toggle('active');
            if (document.getElementById('loanForm').classList.contains('active')) {
                document.getElementById('firstName').focus();
            }
        }

        // Open modal
        function openModal(modalId, loanId = null) {
            currentLoanId = loanId;
            document.getElementById(modalId).style.display = 'flex';
            
            if (modalId === 'paidModal') {
                // Set today's date as default
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('paymentDate').value = today;
                
                // Find the loan to set default payment amount
                if (loanId) {
                    const loan = borrowersData.find(b => b.id === loanId);
                    if (loan) {
                        document.getElementById('paidAmount').value = loan.loanAmount || '';
                    }
                }
            }
        }

        // Close modal
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
            currentLoanId = null;
        }

        // Add late fee to loan
        function addLateFee(loanId) {
            const loan = borrowersData.find(b => b.id === loanId);
            if (!loan) return;
            
            const lateFee = parseFloat(loan.loanAmount) * 0.1; // 10% late fee
            const newAmount = parseFloat(loan.loanAmount) + lateFee;
            
            if (confirm(`Add 10% late fee (ZMW ${lateFee.toFixed(2)}) to ${loan.firstName}'s loan? New total will be ZMW ${newAmount.toFixed(2)}`)) {
                const loanRef = database.ref(`applications/${loanId}`);
                loanRef.update({
                    loanAmount: newAmount
                })
                .then(() => {
                    showNotification('Late Fee Added', `10% late fee added to ${loan.firstName}'s loan`, 'due-today');
                })
                .catch(error => {
                    console.error("Error adding late fee:", error);
                    showNotification('Error', 'Failed to add late fee. Please try again.', 'due-today');
                });
            }
        }

        // Generate PDF receipt
        function generateReceipt(loan) {
            const doc = new jsPDF();
            
            // Add logo and header
            doc.setFontSize(20);
            doc.setTextColor(46, 139, 87);
            doc.text('Damar Enterprise', 105, 20, { align: 'center' });
            
            doc.setFontSize(12);
            doc.setTextColor(0, 0, 0);
            doc.text('Loan Payment Receipt', 105, 30, { align: 'center' });
            
            // Add receipt details
            doc.setFontSize(10);
            doc.text(`Receipt #: ${loan.id.substring(0, 8)}`, 20, 45);
            doc.text(`Date: ${new Date().toLocaleDateString('en-GB')}`, 20, 50);
            
            // Add line
            doc.line(20, 55, 190, 55);
            
            // Add customer details
            doc.setFontSize(12);
            doc.text('Customer Details', 20, 65);
            
            doc.setFontSize(10);
            doc.text(`Name: ${loan.firstName} ${loan.lastName}`, 20, 72);
            doc.text(`Phone: ${loan.phone || 'N/A'}`, 20, 77);
            doc.text(`NRC: ${loan.nrc || 'N/A'}`, 20, 82);
            
            // Add loan details
            doc.setFontSize(12);
            doc.text('Loan Details', 20, 92);
            
            doc.setFontSize(10);
            doc.text(`Loan Amount: ${formatCurrency(loan.loanAmount)}`, 20, 99);
            doc.text(`Amount Paid: ${formatCurrency(loan.paidAmount)}`, 20, 104);
            doc.text(`Payment Date: ${loan.paymentDate || 'N/A'}`, 20, 109);
            
            if (loan.paymentNotes) {
                doc.text(`Notes: ${loan.paymentNotes}`, 20, 114);
            }
            
            // Add footer
            doc.setFontSize(8);
            doc.setTextColor(100, 100, 100);
            doc.text('Thank you for your payment!', 105, 140, { align: 'center' });
            doc.text('Damar Enterprise - Providing financial solutions', 105, 145, { align: 'center' });
            
            // Save the PDF
            doc.save(`receipt_${loan.id.substring(0, 8)}.pdf`);
        }

        // Export active loans to PDF
        function exportActiveLoansToPdf() {
            const doc = new jsPDF();
            
            // Add title
            doc.setFontSize(16);
            doc.setTextColor(46, 139, 87);
            doc.text('Damar Enterprise - Active Loans Report', 105, 15, { align: 'center' });
            
            doc.setFontSize(10);
            doc.setTextColor(0, 0, 0);
            doc.text(`Generated on: ${new Date().toLocaleDateString('en-GB')}`, 105, 22, { align: 'center' });
            
            // Prepare table data
            const headers = [['Name', 'Phone', 'Loan Amount', 'Status', 'Due Date', 'Days Left']];
            const rows = borrowersData
                .filter(loan => !loan.repaid)
                .map(loan => [
                    `${loan.firstName} ${loan.lastName}`,
                    loan.phone || '-',
                    formatCurrency(loan.loanAmount),
                    getStatusText(loan.status, loan.daysUntilDue, loan.repaid),
                    loan.dueDate || '-',
                    formatDaysLeft(loan.daysUntilDue)
                ]);
            
            // Add table
            doc.autoTable({
                head: headers,
                body: rows,
                startY: 30,
                styles: {
                    fontSize: 8,
                    cellPadding: 2,
                    overflow: 'linebreak'
                },
                headStyles: {
                    fillColor: [46, 139, 87],
                    textColor: 255,
                    fontStyle: 'bold'
                },
                alternateRowStyles: {
                    fillColor: [240, 240, 240]
                }
            });
            
            // Save the PDF
            doc.save('damar_active_loans.pdf');
        }

        // Export paid loans to PDF
        function exportPaidLoansToPdf() {
            const doc = new jsPDF();
            
            // Add title
            doc.setFontSize(16);
            doc.setTextColor(46, 139, 87);
            doc.text('Damar Enterprise - Paid Loans Report', 105, 15, { align: 'center' });
            
            doc.setFontSize(10);
            doc.setTextColor(0, 0, 0);
            doc.text(`Generated on: ${new Date().toLocaleDateString('en-GB')}`, 105, 22, { align: 'center' });
            
            // Prepare table data
            const headers = [['Name', 'Phone', 'Loan Amount', 'Paid Amount', 'Payment Date']];
            const rows = paidLoansData.map(loan => [
                `${loan.firstName} ${loan.lastName}`,
                loan.phone || '-',
                formatCurrency(loan.loanAmount),
                formatCurrency(loan.paidAmount),
                loan.paymentDate || '-'
            ]);
            
            // Add table
            doc.autoTable({
                head: headers,
                body: rows,
                startY: 30,
                styles: {
                    fontSize: 8,
                    cellPadding: 2,
                    overflow: 'linebreak'
                },
                headStyles: {
                    fillColor: [46, 139, 87],
                    textColor: 255,
                    fontStyle: 'bold'
                },
                alternateRowStyles: {
                    fillColor: [240, 240, 240]
                }
            });
            
            // Add summary
            const totalLoans = paidLoansData.reduce((sum, loan) => sum + (parseFloat(loan.loanAmount) || 0), 0);
            const totalPaid = paidLoansData.reduce((sum, loan) => sum + (parseFloat(loan.paidAmount) || 0), 0);
            const profit = totalPaid - totalLoans;
            
            const finalY = doc.lastAutoTable.finalY + 10;
            doc.setFontSize(10);
            doc.text(`Total Loans: ${formatCurrency(totalLoans)}`, 20, finalY);
            doc.text(`Total Recovered: ${formatCurrency(totalPaid)}`, 20, finalY + 5);
            doc.text(`Profit: ${formatCurrency(profit)}`, 20, finalY + 10);
            doc.setTextColor(profit >= 0 ? 46 : 231, profit >= 0 ? 139 : 76, profit >= 0 ? 87 : 60);
            doc.setFontStyle('bold');
            doc.text(`Profit: ${formatCurrency(profit)}`, 20, finalY + 10);
            
            // Save the PDF
            doc.save('damar_paid_loans.pdf');
        }

        // Generate performance report
        function generatePerformanceReport() {
            // This would generate a more comprehensive report
            // For now, we'll just export the performance table as CSV
            
            let csv = 'Month,Loans Given,Amount Lent,Amount Recovered,Profit/Loss,Default Rate\n';
            
            const rows = document.querySelectorAll('#performanceTable tr');
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length > 0) {
                    const rowData = [];
                    cells.forEach(cell => {
                        rowData.push(cell.textContent.replace(',', ''));
                    });
                    csv += rowData.join(',') + '\n';
                }
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', 'damar_performance_report.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Helper function to get status text
        function getStatusText(status, daysUntilDue, repaid) {
            if (repaid) return 'Repaid';
            if (status === 'Pending') return 'Pending';
            if (status === 'Rejected') return 'Rejected';
            if (daysUntilDue === null) return 'Active';
            if (daysUntilDue < 0) return 'Overdue';
            if (daysUntilDue === 0) return 'Due Today';
            if (daysUntilDue <= 3) return 'Due Soon';
            return 'Active';
        }

        // Submit new loan
        function submitLoan() {
            const firstName = document.getElementById('firstName').value.trim();
            const lastName = document.getElementById('lastName').value.trim();
            const nrc = document.getElementById('nrc').value.trim();
            const age = document.getElementById('age').value.trim();
            const gender = document.getElementById('gender').value;
            const phone = document.getElementById('phone').value.trim();
            const address = document.getElementById('address').value.trim();
            const loanPurpose = document.getElementById('loanPurpose').value;
            const loanAmount = parseFloat(document.getElementById('loanAmount').value);
            const repaymentPeriod = document.querySelector('input[name="repaymentPeriod"]:checked').value;
            const termsAgreed = document.getElementById('termsAgreement').checked;
            
            // Validate inputs
            if (!firstName || !lastName || !nrc || !age || !gender || !phone || !address || !loanPurpose || !loanAmount || !repaymentPeriod || !termsAgreed) {
                showNotification('Validation Error', 'Please fill in all required fields', 'due-today');
                return;
            }
            
            if (phone.length < 9 || phone.length > 12) {
                showNotification('Validation Error', 'Please enter a valid phone number (9-12 digits)', 'due-today');
                return;
            }
            
            if (age < 18 || age > 99) {
                showNotification('Validation Error', 'Borrower must be between 18 and 99 years old', 'due-today');
                return;
            }
            
            const loanData = {
                firstName,
                lastName,
                nrc,
                age,
                gender,
                phone,
                address,
                loanPurpose,
                loanAmount,
                repaymentPeriod,
                dueDate: calculateDueDate(repaymentPeriod),
                applicationDate: new Date().toISOString(),
                status: 'Pending',
                timestamp: firebase.database.ServerValue.TIMESTAMP
            };
            
            addLoan(loanData);
        }

        // Confirm payment
        function confirmPayment() {
            const paidAmount = parseFloat(document.getElementById('paidAmount').value);
            const paymentDate = document.getElementById('paymentDate').value;
            
            if (!paidAmount || isNaN(paidAmount)) {
                showNotification('Validation Error', 'Please enter a valid payment amount', 'due-today');
                return;
            }
            
            if (!paymentDate) {
                showNotification('Validation Error', 'Please select a payment date', 'due-today');
                return;
            }
            
            const paymentData = {
                amount: paidAmount,
                date: new Date(paymentDate).toLocaleDateString('en-GB'),
                notes: document.getElementById('paymentNotes').value.trim()
            };
            
            markLoanAsPaid(currentLoanId, paymentData);
        }

        // Calculate loan details
        function calculateLoan() {
            const amount = parseFloat(document.getElementById('calcLoanAmount').value) || 0;
            const period = parseInt(document.querySelector('input[name="calcRepaymentPeriod"]:checked').value);
            
            // Determine interest rate based on period
            let interestRate;
            switch(period) {
                case 7:
                    interestRate = 16; // 1 week = 16%
                    break;
                case 14:
                    interestRate = 20; // 2 weeks = 20%
                    break;
                case 21:
                    interestRate = 25; // 3 weeks = 25%
                    break;
                case 28:
                    interestRate = 30; // 4 weeks = 30%
                    break;
                default:
                    interestRate = 10; // Default fallback
            }
            
            if (amount <= 0 || period <= 0) {
                showNotification('Calculation Error', 'Please enter valid values for all fields', 'due-today');
                return;
            }
            
            const interestAmount = (amount * interestRate / 100);
            const totalRepayment = amount + interestAmount;
            const dailyRepayment = totalRepayment / period;
            const weeklyRepayment = dailyRepayment * 7;
            
            // Display results
            document.getElementById('calcPrincipal').textContent = formatCurrency(amount);
            document.getElementById('calcInterest').textContent = formatCurrency(interestAmount);
            document.getElementById('calcTotal').textContent = formatCurrency(totalRepayment);
            document.getElementById('calcDaily').textContent = formatCurrency(dailyRepayment);
            document.getElementById('calcWeekly').textContent = formatCurrency(weeklyRepayment);
            
            // Show results
            document.getElementById('calculatorResults').style.display = 'block';
        }

        // Handle login
        function handleLogin(e) {
            e.preventDefault();
            
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();
            const errorElement = document.getElementById('loginError');
            
            // Correct credentials
            const correctUsername = 'admin';
            const correctPassword = 'Damar12345';
            
            if (username === correctUsername && password === correctPassword) {
                // Hide login screen and show app
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('appContainer').style.display = 'block';
                
                // Initialize the app
                fetchBorrowers();
            } else {
                // Show error
                errorElement.style.display = 'block';
                document.getElementById('password').value = '';
                document.getElementById('password').focus();
            }
        }

        // Switch tabs
        function switchTab(tabId) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Show selected tab content
            document.getElementById(`${tabId}-tab`).classList.add('active');
            
            // Update active tab
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`.tab[data-tab="${tabId}"]`).classList.add('active');
            
            // Update charts when switching to relevant tabs
            if (tabId === 'dashboard') {
                updatePerformanceChart(borrowersData, paidLoansData);
                updateRepaymentChart(borrowersData, paidLoansData);
            } else if (tabId === 'reports') {
                updateProfitChart(paidLoansData);
            }
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            // Set up login form
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            
            // Dark mode toggle event
            document.getElementById('darkModeToggle').addEventListener('click', toggleDarkMode);
            
            // Form buttons
            document.getElementById('newLoanBtn').addEventListener('click', toggleForm);
            document.getElementById('newLoanBtn2').addEventListener('click', toggleForm);
            document.getElementById('cancelLoanBtn').addEventListener('click', toggleForm);
            document.getElementById('submitLoanBtn').addEventListener('click', submitLoan);
            
            // Notification close button
            document.getElementById('closeNotification').addEventListener('click', closeNotification);
            
            // Phone number validation
            document.getElementById('phone').addEventListener('input', function(e) {
                this.value = this.value.replace(/[^0-9]/g, '');
            });
            
            // NRC validation
            document.getElementById('nrc').addEventListener('input', function(e) {
                this.value = this.value.replace(/[^0-9\/]/g, '');
            });
            
            // Submit form on Enter key
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && document.getElementById('loanForm').classList.contains('active')) {
                    submitLoan();
                }
            });
            
            // Calculator button
            document.getElementById('calculateBtn').addEventListener('click', calculateLoan);
            
            // Tab switching
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    switchTab(this.getAttribute('data-tab'));
                });
            });
            
            // Make calculator inputs numeric only
            document.getElementById('calcLoanAmount').addEventListener('input', function(e) {
                this.value = this.value.replace(/[^0-9.]/g, '');
            });
            
            // Auto-calculate when repayment period changes
            document.querySelectorAll('input[name="calcRepaymentPeriod"]').forEach(radio => {
                radio.addEventListener('change', calculateLoan);
            });
            
            // Chart period changes
            document.getElementById('chartPeriod').addEventListener('change', function() {
                updatePerformanceChart(borrowersData, paidLoansData);
            });
            
            document.getElementById('profitChartPeriod').addEventListener('change', function() {
                updateProfitChart(paidLoansData);
            });
            
            // Modal buttons
            document.getElementById('closePaidModal').addEventListener('click', function() {
                closeModal('paidModal');
            });
            
            document.getElementById('cancelPaymentBtn').addEventListener('click', function() {
                closeModal('paidModal');
            });
            
            document.getElementById('confirmPaymentBtn').addEventListener('click', confirmPayment);
            
            // Export buttons
            document.getElementById('exportPdfBtn').addEventListener('click', exportActiveLoansToPdf);
            document.getElementById('exportPaidPdfBtn').addEventListener('click', exportPaidLoansToPdf);
            document.getElementById('generateReportBtn').addEventListener('click', generatePerformanceReport);
            
            // Set today's date as default for payment date
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('paymentDate').value = today;
        });
    </script>
</body>
</html>